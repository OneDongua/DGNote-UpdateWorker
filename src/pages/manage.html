<!doctype html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>版本管理后台</title>
		<script src="https://code.jquery.com/jquery-4.0.0.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
		<style>
			:root {
				--primary-color: #2563eb;
				--primary-hover: #1d4ed8;
				--success-color: #10b981;
				--danger-color: #ef4444;
				--warning-color: #f59e0b;
				--text-primary: #1f2937;
				--text-secondary: #6b7280;
				--border-color: #e5e7eb;
				--bg-light: #ebf5fe;
				--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
				--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
				--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
				--radius-sm: 6px;
				--radius-md: 8px;
				--radius-lg: 12px;
			}

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: sans-serif;
				background: var(--bg-light);
				color: var(--text-primary);
				line-height: 1.6;
				min-height: 100vh;
				padding: 20px;
			}

			.container {
				max-width: 800px;
				margin: 0 auto;
			}

			header {
				text-align: center;
				margin-bottom: 40px;
				padding: 20px 0;
			}

			h1 {
				font-size: 2.5rem;
				font-weight: 700;
				color: var(--text-primary);
				margin-bottom: 8px;
				background: var(--primary-color);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.subtitle {
				color: var(--text-secondary);
				font-size: 1.1rem;
				font-weight: 400;
			}

			.main-content {
				background: white;
				border-radius: var(--radius-lg);
				box-shadow: var(--shadow-lg);
				overflow: hidden;
			}

			.section {
				padding: 32px;
				border-bottom: 1px solid var(--border-color);
			}

			.section:last-child {
				border-bottom: none;
			}

			.section-header {
				margin-bottom: 24px;
			}

			h3 {
				font-size: 1.5rem;
				font-weight: 600;
				color: var(--text-primary);
				margin-bottom: 8px;
			}

			.section-description {
				color: var(--text-secondary);
				font-size: 0.95rem;
			}

			label {
				display: block;
				font-weight: 500;
				color: var(--text-primary);
				margin-bottom: 8px;
				font-size: 0.95rem;
			}

			input,
			textarea {
				width: 100%;
				padding: 12px 16px;
				border: 2px solid var(--border-color);
				border-radius: var(--radius-md);
				font-size: 1rem;
				transition: all 0.2s ease;
				background: white;
				color: var(--text-primary);
			}

			input:focus,
			textarea:focus {
				outline: none;
				border-color: var(--primary-color);
				box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
			}

			input::placeholder,
			textarea::placeholder {
				color: var(--text-secondary);
			}

			.btn-container {
				display: flex;
				gap: 12px;
				flex-wrap: wrap;
				margin-top: 20px;
			}

			button {
				padding: 12px 24px;
				border: none;
				border-radius: var(--radius-md);
				font-size: 0.95rem;
				font-weight: 500;
				cursor: pointer;
				transition: all 0.2s ease;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				min-width: 100px;
			}

			button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}

			.btn-primary {
				background: var(--primary-color);
				color: white;
			}

			.btn-primary:hover:not(:disabled) {
				background: var(--primary-hover);
				transform: translateY(-1px);
				box-shadow: var(--shadow-md);
			}

			.btn-success {
				background: var(--success-color);
				color: white;
			}

			.btn-success:hover:not(:disabled) {
				background: #059669;
				transform: translateY(-1px);
				box-shadow: var(--shadow-md);
			}

			.btn-danger {
				background: var(--danger-color);
				color: white;
			}

			.btn-danger:hover:not(:disabled) {
				background: #dc2626;
				transform: translateY(-1px);
				box-shadow: var(--shadow-md);
			}

			.btn-outline {
				background: transparent;
				border: 2px solid var(--border-color);
				color: var(--text-primary);
			}

			.btn-outline:hover:not(:disabled) {
				border-color: var(--primary-color);
				color: var(--primary-color);
				transform: translateY(-1px);
				box-shadow: var(--shadow-sm);
			}

			.logout-section {
				padding: 24px 32px;
				text-align: right;
				background: #f9f9f9;
			}

			.toast {
				position: fixed;
				top: 32px;
				left: 50%;
				padding: 16px 24px;
				border-radius: var(--radius-md);
				color: white;
				font-weight: 500;
				font-size: 0.95rem;
				z-index: 1000;
				transform: translate(-50%, -180%);
				transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
				box-shadow: var(--shadow-lg);
				min-width: 280px;
				text-align: center;
			}

			.toast.show {
				transform: translate(-50%, 0);
			}

			.toast.success {
				background: var(--success-color);
			}

			.toast.error {
				background: var(--danger-color);
			}

			.toast.warning {
				background: var(--warning-color);
			}

			/* 响应式设计 */
			@media (max-width: 768px) {
				body {
					padding: 16px;
				}
				
				.container {
					max-width: 100%;
				}
				
				h1 {
					font-size: 2rem;
				}
				
				.section {
					padding: 24px;
				}
				
				.btn-container {
					flex-direction: column;
				}
				
				button {
					width: 100%;
				}
			}

			/* 加载动画 */
			@keyframes fadeInUp {
				from {
					opacity: 0;
					transform: translateY(20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.main-content {
				animation: fadeInUp 0.6s ease-out;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header>
				<h1>版本管理后台</h1>
			</header>

			<!-- Toast 通知容器 -->
			<div id="toastContainer"></div>

			<main class="main-content">
				<!-- 新建 / 更新版本 -->
				<section class="section">
					<div class="section-header">
						<h3>版本管理</h3>
						<p class="section-description">创建、更新或删除应用程序版本</p>
					</div>

					<label for="versionKey">版本号</label>
					<input type="text" id="versionKey" placeholder="例如: v1.2.3" />

					<label for="jsonValue">JSON 配置内容</label>
					<textarea id="jsonValue" rows="16" placeholder='{
    "name": "版本名称",
    "code": 123,
    "logs": "更新日志",
    "links": [
        {
            "link": "下载链接",
            "pwd": "密码",
            "desc": "描述"
        }
    ]
}'></textarea>

					<div class="btn-container">
						<button id="createBtn" class="btn-primary">新建版本</button>
						<button id="updateBtn" class="btn-success">更新版本</button>
						<button id="deleteBtn" class="btn-danger">删除版本</button>
						<button id="templateBtn" class="btn-outline">复制模板</button>
					</div>
				</section>

				<!-- 最新管理 -->
				<section class="section">
					<div class="section-header">
						<h3>最新版本设置</h3>
						<p class="section-description">设置当前最新版本标识</p>
					</div>

					<label for="latestValue">版本号</label>
					<input type="text" id="latestValue" placeholder="输入最新的版本号" />

					<div class="btn-container">
						<button id="updateLatestBtn" class="btn-primary">更新</button>
					</div>
				</section>

				<!-- 文本换行符转换工具 -->
				<section class="section">
					<div class="section-header">
						<h3>文本工具</h3>
						<p class="section-description">换行符转换与文本处理工具</p>
					</div>

					<label for="textConverter">文本内容</label>
					<textarea id="textConverter" rows="12" placeholder="在此输入文本，点击转换按钮将换行符转换为\n"></textarea>

					<div class="btn-container">
						<button id="convertLineBreaksBtn" class="btn-primary">转换换行符</button>
						<button id="copyConvertedBtn" class="btn-success" data-clipboard-target="#textConverter">复制结果</button>
						<button id="clearConverterBtn" class="btn-outline">清空</button>
					</div>
				</section>

				<!-- 登出区域 -->
				<div class="logout-section">
					<button id="logoutBtn" class="btn-danger">安全登出</button>
				</div>
			</main>
		</div>

		<script>
			function showToast(message, isError = false) {
				// 创建 toast 元素
				const toast = $(`<div class="toast ${isError ? "error" : "success"}">${message}</div>`);

				// 添加到容器
				$("#toastContainer").append(toast);

				// 显示 toast
				setTimeout(() => {
					toast.addClass("show");
				}, 10);

				// 3秒后自动隐藏并移除
				setTimeout(() => {
					toast.removeClass("show");
					setTimeout(() => {
						toast.remove();
					}, 300);
				}, 3000);
			}

			// 新建版本
			$("#createBtn").click(function () {
				const key = $("#versionKey").val().trim();
				const valueText = $("#jsonValue").val().trim();

				if (!key || !valueText) {
					showToast("版本号和 JSON 必填", true);
					return;
				}

				let json;
				try {
					json = JSON.parse(valueText);
				} catch (e) {
					showToast("JSON 格式错误", true);
					return;
				}

				$.ajax({
					url: "/admin/kv",
					method: "POST",
					contentType: "application/json",
					data: JSON.stringify({
						key: key,
						value: json,
						type: "json",
					}),
					success: function (res) {
						showToast(res.message);
					},
					error: function (xhr) {
						showToast(xhr.responseJSON?.message || "请求失败", true);
					},
				});
			});

			// 更新版本
			$("#updateBtn").click(function () {
				const key = $("#versionKey").val().trim();
				const valueText = $("#jsonValue").val().trim();

				if (!key || !valueText) {
					showToast("版本号和 JSON 必填", true);
					return;
				}

				let json;
				try {
					json = JSON.parse(valueText);
				} catch (e) {
					showToast("JSON 格式错误", true);
					return;
				}

				$.ajax({
					url: "/admin/kv/" + encodeURIComponent(key),
					method: "PUT",
					contentType: "application/json",
					data: JSON.stringify({
						value: json,
						type: "json",
					}),
					success: function (res) {
						showToast(res.message);
					},
					error: function (xhr) {
						showToast(xhr.responseJSON?.message || "请求失败", true);
					},
				});
			});

			// 删除版本
			$("#deleteBtn").click(function () {
				const key = $("#versionKey").val().trim();

				if (!key) {
					showToast("版本号必填", true);
					return;
				}

				if (!confirm("确定删除该版本？")) return;

				$.ajax({
					url: "/admin/kv/" + encodeURIComponent(key),
					method: "DELETE",
					success: function (res) {
						showToast(res.message);
					},
					error: function (xhr) {
						showToast(xhr.responseJSON?.message || "请求失败", true);
					},
				});
			});

			// 设置 latest（新建）
			$("#setLatestBtn").click(function () {
				const latest = $("#latestValue").val().trim();

				if (!latest) {
					showToast("请输入版本号", true);
					return;
				}

				$.ajax({
					url: "/admin/kv",
					method: "POST",
					contentType: "application/json",
					data: JSON.stringify({
						key: "latest",
						value: latest,
						type: "text",
					}),
					success: function (res) {
						showToast(res.message);
					},
					error: function (xhr) {
						showToast(xhr.responseJSON?.message || "请求失败", true);
					},
				});
			});

			// 更新 latest
			$("#updateLatestBtn").click(function () {
				const latest = $("#latestValue").val().trim();

				if (!latest) {
					showToast("请输入版本号", true);
					return;
				}

				$.ajax({
					url: "/admin/kv/latest",
					method: "PUT",
					contentType: "application/json",
					data: JSON.stringify({
						value: latest,
						type: "text",
					}),
					success: function (res) {
						showToast(res.message);
					},
					error: function (xhr) {
						showToast(xhr.responseJSON?.message || "请求失败", true);
					},
				});
			});

			$("#logoutBtn").click(function () {
				$.ajax({
					url: "/auth/logout",
					method: "POST",
					success: function (res) {
						showToast("登出成功");
						setTimeout(function () {
							window.location.href = "/login";
						}, 1000);
					},
					error: function (xhr) {
						showToast(xhr.responseJSON?.message || "登出失败", true);
					},
				});
			});

			$(document).ready(function () {
				$.ajax({
					url: "/auth/me",
					method: "GET",
					success: function (data) {
						if (data.authenticated) {
							if (data.user.role === "admin") {
								showToast("已登录: " + data.user.username);
							} else {
								showToast("无权限", true);
								$("input, textarea, button:not(#logoutBtn)").prop("disabled", true);
							}
						} else {
							showToast("未登录", true);
							setTimeout(function () {
								window.location.href = "/login";
							}, 1000);
						}
					},
					error: function (xhr) {
						showToast("请求登录状态失败", true);
						$("input, textarea, button:not(#logoutBtn)").prop("disabled", true);
					},
				});
			});

			// 文本换行符转换功能
			$("#convertLineBreaksBtn").click(function () {
				const originalText = $("#textConverter").val();

				if (!originalText.trim()) {
					showToast("请输入要转换的文本", true);
					return;
				}

				// 将换行符替换为 \n
				const convertedText = originalText.replace(/\r\n/g, "\\n").replace(/\n/g, "\\n").replace(/\r/g, "\\n");

				$("#textConverter").val(convertedText);
				showToast("转换完成");
			});

			// 清空文本框
			$("#clearConverterBtn").click(function () {
				$("#textConverter").val("");
				showToast("已清空");
			});

			// 初始化 clipboard.js for 文本转换器
			const converterClipboard = new ClipboardJS("#copyConvertedBtn");
			converterClipboard.on("success", function (e) {
				showToast("复制成功");
			});
			converterClipboard.on("error", function (e) {
				showToast("复制失败", true);
			});

			const templateClipboard = new ClipboardJS("#templateBtn", {
				text: function (trigger) {
					return `{
    "name": "",
    "code": ,
    "logs": "",
    "links": [
        {
            "link": "https://www.123912.com/s/Da8RVv-MRlgv",
            "pwd": "oqWm",
            "desc": "123网盘"
        },
        {
            "link": "https://1drv.ms/f/c/a25aea7bf332078a/IgDrjgY0ekVFToOvxVh6RwuvAZw7xMLIPlls939jnZ_o088",
            "desc": "OneDrive"
        },
        {
            "link": "https://pan.quark.cn/s/caa69bee6c07",
            "desc": "夸克网盘"
        }
    ]
}`;
				},
			});
			templateClipboard.on("success", function (e) {
				showToast("复制成功");
			});
			templateClipboard.on("error", function (e) {
				showToast("复制失败", true);
			});
		</script>
	</body>
</html>
